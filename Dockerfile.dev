# Dockerfile.dev - Development version using local files
ARG PHP_VERSION=8.4
ARG DEBIAN_VERSION=trixie

# Stage 1: Build nfdump
FROM debian:${DEBIAN_VERSION}-slim AS build
# Set environment variables
ENV DEBIAN_FRONTEND=noninteractive
ENV TZ="UTC"

# Install dependencies
RUN apt-get update && \
    apt-get install -y \
    git build-essential clang-19 libtool-bin pkgconf bison flex liblz4-dev libbz2-dev zlib1g-dev librrd-dev

WORKDIR /build

# Download and build nfdump from source
RUN git clone https://github.com/phaag/nfdump.git --single-branch -b master && \
    cd nfdump && \
    ./autogen.sh && \
    CC=clang-19 ./configure --prefix=/usr/local/nfdump --enable-maxmind --enable-ja4 && \
    make && \
    make install

# Base image
FROM php:${PHP_VERSION}-apache-${DEBIAN_VERSION} AS final
# Set environment variables
ENV DEBIAN_FRONTEND=noninteractive
ENV TZ="UTC"
WORKDIR /var/www/html

# Install dependencies required for nfdump and NFSen-NG
RUN apt-get update && apt-get install -y --no-install-recommends \
    git rrdtool curl librrd-dev \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/*

# Copy built nfdump
COPY --from=build /usr/local/nfdump /usr/local/nfdump

# Add nfdump to PATH
ENV PATH="/usr/local/nfdump/bin:${PATH}"

# ld library
RUN ldconfig

# Enable Apache modules
RUN a2enmod rewrite deflate headers expires

# Install PHP RRD extension
RUN pecl install rrd \
    && echo "extension=rrd.so" > /usr/local/etc/php/conf.d/rrd.ini

# Setup volumes for persistent data and configuration
VOLUME ["/data/nfsen-ng", "/config/nfsen-ng", "/data/nfcapd"]

# Copy local nfsen-ng files (with your fixes) instead of cloning
COPY . /var/www/html

# Install composer and backend dependencies
RUN curl -sS https://getcomposer.org/download/latest-stable/composer.phar -o /usr/local/bin/composer \
    && chmod +x /usr/local/bin/composer \
    && composer install --no-dev

# Copy entrypoint script
COPY docker-entrypoint.sh /usr/local/bin/docker-entrypoint.sh
RUN chmod +x /usr/local/bin/docker-entrypoint.sh

EXPOSE 80

ENTRYPOINT ["/usr/local/bin/docker-entrypoint.sh"]
CMD ["apache2-foreground"]
